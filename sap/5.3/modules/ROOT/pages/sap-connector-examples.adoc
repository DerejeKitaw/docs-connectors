= SAP Connector 5.3 Examples - Mule 4
:page-aliases: connectors::sap/sap-connector-examples.adoc

== Establish an SAP Connection

This example shows you how to create a Mule app that establishes a connection to SAP and receives a function using the SAP connector's *Function listener* source. The example then transforms the data and

The following screenshot shows the Anypoint Studio flow for this example:

image::sap-connector-example-establish-connection.png[Studio flow for establishing an SAP connection]

To create the flow:

. In Anypoint Studio, create a new Mule project.
. In the Mule Palette view, click *(X) Search in Exchange*.
. In *Add Dependencies to Project*, enter `sap connector` in the search field.
. Click *SAP Connector - Mule 4* in *Available Modules*.
. Select the connector, click *Add*, and then click *Finish*.
. In the *Mule Palette* view, drag the *Function listener* source to the canvas.
. Create a global element named `SAP_Inbound` and specify the X.509 certificate, SAP system number, SAP client ID, and either the application server host or message host.
. Configure the required fields in the properties tab.
. From the *Mule Palette* view, select *Transform Message* and drag it next to *Function listener*.
. Specify the details based on the metadata. For example:
+
image::sap-function-return-response.png[Sample metadata for the SAP_Inbound global element]
+
The SAP Design Studio displays feedback about the received object and its response:
+
image::sap-result-sap-gui.png[SAP feedback for the received object and its response]

== Send an IDoc to SAP

This example shows you how to create a Mule app that uses sends an IDoc to SAP. The following screenshot shows the Studio flow for this example:

image::sap-connector-example-send-idoc.png[Studio flow for sending an IDoc to SAP]

=== Configure HTTP Listener

. In Anypoint Studio, create a new Mule project.
. In the *Mule Palette* view, drag the *HTTP > Listener* operation to the canvas to start the flow.
. Configure the global element using the default values.
. In the *Listener* properties tab, set the path to `/sendIDoc`.

=== Add the Transform Message Component

. From the *Mule Palette* view, select *Core* and drag the *Transform Message* operation to the right of the *Listener* component.
. After the metadata is retrieved, overlay the text in *Output* section of the *Transform Message* Component with text like the following:
+
*Reviewers, is this text OK?*
+
[source,dataweave,linenums]
----
%dw 2.0
output application/xml
---
read('<?xml version="1.0"?>
<MATMAS01>
    <IDOC BEGIN="1">
        <EDI_DC40 SEGMENT="1">
             <TABNAM>EDI_DC40</TABNAM>
            <MANDT>800</MANDT>
        </EDI_DC40>
    </IDOC>
</MATMAS01>
----

=== Add the Send IDoc operation

. From the *Mule Palette* view, select *SAP* and drag the *Send IDoc* operation next to the *Transform* component.
. Create a global element named `SAP_Outbound` and specify the connection information.
. Click *Test Connection* to confirm that Mule runtime engine can connect with the SAP instance.
* If the connection is successful, save the configuration.
+
* Otherwise, review and correct any invalid parameters, and test again.
+
. Configure the *Send Idoc* properties with the following values:
+
[%header,cols="40s,60a"]
|===
|Parameter |Value
|IDoc Name |MATMAS01
|Content |`#[payload]`
|===

=== Add the Logger Component

. From the *Mule Palette* view, select *Core* and drag *Logger* next to the *Send IDoc* component.
. Click *File* > *Save* to save the app.

When you run your app, *Logger* displays messages in Studio console that enable you to see the connector payload in the logs.

=== Run the Application

. Click *Run* > *Run as* > *Mule Application* to run the app.
+
. From a web browser, test the application by entering an employee's internal ID, first name, and last name as query parameters for the following URL:
+
[source]
----
http://localhost:8081/sendIDoc
----
+
Mule adds the employee record.

=== XML for sending an IDoc to SAP

Paste this code into a new Mule app in Studio to quickly load the flow for the Send IDoc example. Change the values to reflect your environment.

[source,xml,linenums]
----

----

=== Trigger An Incoming IDoc Request

In this example, the app acts like an RFC server and registers itself at an SAP gateway. It waits for incoming IDoc requests from an external SAP system.

The following screenshot shows the Studio flow for this example:

image::sap-connector-example-receive-idoc.png[Studio flow for receiving incoming IDoc requests]


. In Anypoint Studio, create a new Mule project.
. From the *Mule Palette* view, select *SAP* and drag the *Document listener* operation to the canvas.
. Create a new *SAP_Outbound* global element configuration and specify the X.509 certificate, SAP system number, SAP client ID, and either the application server host or message host.
. Click *Test Connection* to confirm that Mule runtime engine can connect with the SAP instance.
. If the connection is successful, save the configuration.
+
Otherwise, review and correct any invalid parameters, and test again.
+
. In the *Mule Palette* view, select *Core* and drag a *Logger* component next to *Document listener* on the canvas.
+
When you run your app, the *Logger* component displays messages in the Anypoint Studio console that enables you to see the connector payload in the logs.
+
. From the *Mule Palette* view, select *HTTP* and drag the *Listener* operation to the canvas to start a new flow.
. Configure the global element using the default values.
. In the *Listener* properties tab, set the path to `/trigger`.
. Drag the *HTTP > Request* operation to the canvas and set the *Path* field to `/triggerIDoc`.
+
Use the same global element configuration that you used for the *HTTP Listener* operation. (*Reviewers: I am not able to do this.*)
+
. Drag a *Transform Message* component next to *Listener*.
+
The content of this message is the payload of the BAPI function that sends IDocs from SAP to the SAP Connector *Document Listener* source.
*Reviewers, is this text OK as is? If not, can you help me reword it?*
+
. In the *Output* of the *Transform Message* component, overlay the brackets with this text:
+
[source,dataweave,linenums]
----
%dw 2.0
output application/xml
---
{
	ZMMFM_TRIGGER_IDOC_MATMAS: {
		"import": {
	IV_MTYP: "MATMAS"
,
IV_OBJ: "23"
,
IV_SYS: "MULE11_LS"
}
,
export: {
	EV_RET: "0"
},export: {
	EV_OBJ: "0000000003526552"
},export: null,changing: null,
tables: {
	T_MSG: null
},
	}
}
----
+
. From the *Mule Palette* view, select *SAP* and Drag the *Synchronous Remote Function Call* operation next to the *Transform Message* component.
+
This operation causes requested IDocs to be sent to the *Document Listener* source.
+
. Use the same global element configuration as used in the *Document Listener* operation.
+
. Enter the key value.
*Reviewers, I am not finding a field for the key value, either for the Simple connection provider or the Certificate connection. What is this referring to*
+
If the key value is correct, the payload of the function in *Transform Message* appears: *Where is the key value entered*.
+
image::sap-connector-remote-function-call-key.png[Payload for the function in the Transform Message component]
+
. Click *File* > *Save* to save your app.
. Click *Run* > *Run as* > *Mule Application* to run the app.
+
Anypoint Studio provides a web server you can use to test the app from a browser.
. From a web browser, test the application by entering +`http://localhost:8081/triggerIDoc`.

On the canvas the flows should look like this:

image::sap-remote-function-call-flow.png[Flow for triggering an IDoc Request]

Example response:

[source,dataweave,linenums]
----
<MATMAS01>
 	<IDOC BEGIN="1">
 		<EDI_DC40 SEGMENT="1">
 			<TABNAM>EDI_DC40</TABNAM>
 			<MANDT>800</MANDT>
 			<DOCNUM>0000000003572826</DOCNUM>
 			<DOCREL>740</DOCREL>
 			<STATUS>30</STATUS>
 			<DIRECT>1</DIRECT>
 			<OUTMOD>2</OUTMOD>
 			<IDOCTYP>MATMAS01</IDOCTYP>
 			<MESTYP>MATMAS</MESTYP>
 			<SNDPOR>SAPIDE</SNDPOR>
 			<SNDPRT>LS</SNDPRT>
 			<SNDPRN>T90CLNT090</SNDPRN>
 			<RCVPOR>MULE11_TP</RCVPOR>
 			<RCVPRT>LS</RCVPRT>
 			<RCVPRN>MULE11_LS</RCVPRN>
 			<CREDAT>20191004</CREDAT>
 			<CRETIM>050305</CRETIM>
 			<SERIAL>20191004050305</SERIAL>
 		</EDI_DC40>

 		...

    ```
----

== See Also

* xref:connectors::introduction/introduction-to-anypoint-connectors.adoc[Introduction to Anypoint Connectors]
* https://help.mulesoft.com[MuleSoft Help Center]
