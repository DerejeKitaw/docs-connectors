= Salesforce CDP Connector 1.0 Examples - Mule 4

The following examples show how to do streaming and bulk operations such as upsert, query, and delete with the Salesforce CDP Connector:

<<Upsert Data - Streaming API>> +
Shows how to upsert data via the streaming api to an object's endpoint.

<<Query Data>> +
Shows how to query data via the streaming api using a custom SOQL query.

<<Delete Data - Streaming API>> +
Shows how to delete records via the streaming api for specific objects.

== Upsert Data - Streaming API

This Mule flow shows how to upsert data via the streaming api to an object's endpoint.
Here is what each operation is doing:

* HTTP Listener: Accepts data from HTTP PUT requests with the connector and object name as uri parameters
* Logger: Shows the HTTP request received from the Listener, then later shows the result from the Upsert Objects operation.
* Streaming Upsert:
+
** Authenticates based on your choice between JWT or username password
** Receives the connector name, object name, and payload from before
** Calls the Salesforce API to upsert the payload to that object's endpoint

image::upsert-flow.png[]

=== XML for this example

Paste this code into the Studio XML editor to quickly load the flow for this example into your Mule app:

[source,xml,linenums]
----
<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:sdc="http://www.mulesoft.org/schema/mule/sdc" xmlns:http="http://www.mulesoft.org/schema/mule/http"
	  xmlns="http://www.mulesoft.org/schema/mule/core"
	  xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/sdc http://www.mulesoft.org/schema/mule/sdc/current/mule-sdc.xsd">
	<http:listener-config name="HTTP_Listener_config" doc:name="HTTP Listener config" doc:id="73958bf0-0d4b-41bb-9628-904ad234ab83" >
		<http:listener-connection host="0.0.0.0" port="8081" />
	</http:listener-config>
    <configuration-properties doc:name="Configuration properties" doc:id="5be8f024-2cd5-44ba-ab5d-83fb70236381" file="mule-app.properties" />
    <sdc:sdc-config name="Salesforce_CDP_OAuth_JWT_config" doc:name="Salesforce CDP config" doc:id="db8d8261-133b-44a3-908c-90d4b977687c" >
		<sdc:oauth-jwt-connection consumerKey="${server.consumerKey}" keyStorePath="${server.keyStorePath}" storePassword="${server.keyStorePassword}" subject="${server.userName}" keyAlias="${server.certificateAlias}" audienceUrl="${server.audienceUrl}"/>
	</sdc:sdc-config>
	<sdc:sdc-config name="Salesforce_CDP_OAuth_UsernamePassword_config" doc:name="Salesforce CDP config" doc:id="d54deb47-5647-44c4-b7c8-19b49b77a4a5" >
		<sdc:oauth-user-pass-connection audienceUrl="${server.audienceUrl}" username="${server.userName}" password="${server.password}" clientId="${server.consumerKey}" clientSecret="${server.consumerSecret}"/>
	</sdc:sdc-config>

	<flow name="upsert-objectsFlow" doc:id="936990c5-feaa-4bb6-9fb6-b2d54cebbaf9" >
		<http:listener doc:name="PUT /upsert/{connectorName}/{objectName}" doc:id="3517489a-d86b-41a5-9718-ab1ff325ba57" config-ref="HTTP_Listener_config" path="/upsert/{connectorName}/{objectName}" allowedMethods="PUT"/>
		<logger level="INFO" doc:name="Request Logger" doc:id="724765c1-69fe-4c46-9a72-fd8d65a122b9" message="#[payload]"/>
		<sdc:upsert-objects doc:name="Streaming Upsert" doc:id="3aed0f42-09e7-4686-8593-053f573f5e1c" config-ref="Salesforce_CDP_OAuth_JWT_config" connectorNameUriParam="#[attributes.uriParams.connectorName]" objectNameUriParam="#[attributes.uriParams.objectName]"/>
		<logger level="INFO" doc:name="Response Logger" doc:id="537b9b1c-5dad-4d39-bce4-287735bed853" />
	</flow>
</mule>
----

=== Steps for running this example

// Add these steps to the end of the numbered list:
. Make sure your connector is already configured
. Save the project.
. Test the flow by sending a PUT to localhost:8081/{CONNECTOR_NAME}/{OBJECT_NAME} with a JSON payload matching
your object's schema, for example:
[source,json,linenums]
----
{
    "data": [
        {
            "your_object_field_1": "value_1",
            "your_object_field_2": "value_2",
            "your_object_field_3": "value_3"
        }
    ]
}
----

== Query Data

This Mule flow shows how to query data from CDP using a custom SOQL query.
Here is what each operation is doing:

* HTTP Listener: Accepts data from HTTP PUT requests with the query in the payload
* Logger: Shows the HTTP request received from the Listener, then later shows the result from the Upsert Objects operation.
* Query:
+
** Authenticates based on your choice between JWT or username password
** Receives the SOQL query from before
** Calls the Salesforce API with the query and receives the result

image::query-flow.png[]

=== XML for this example

Paste this code into the Studio XML editor to quickly load the flow for this example into your Mule app:

[source,xml,linenums]
----
<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:sdc="http://www.mulesoft.org/schema/mule/sdc" xmlns:http="http://www.mulesoft.org/schema/mule/http"
	  xmlns="http://www.mulesoft.org/schema/mule/core"
	  xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/sdc http://www.mulesoft.org/schema/mule/sdc/current/mule-sdc.xsd">
	<http:listener-config name="HTTP_Listener_config" doc:name="HTTP Listener config" doc:id="73958bf0-0d4b-41bb-9628-904ad234ab83" >
		<http:listener-connection host="0.0.0.0" port="8081" />
	</http:listener-config>
    <configuration-properties doc:name="Configuration properties" doc:id="5be8f024-2cd5-44ba-ab5d-83fb70236381" file="mule-app.properties" />
    <sdc:sdc-config name="Salesforce_CDP_OAuth_JWT_config" doc:name="Salesforce CDP config" doc:id="db8d8261-133b-44a3-908c-90d4b977687c" >
		<sdc:oauth-jwt-connection consumerKey="${server.consumerKey}" keyStorePath="${server.keyStorePath}" storePassword="${server.keyStorePassword}" subject="${server.userName}" keyAlias="${server.certificateAlias}" audienceUrl="${server.audienceUrl}"/>
	</sdc:sdc-config>
	<sdc:sdc-config name="Salesforce_CDP_OAuth_UsernamePassword_config" doc:name="Salesforce CDP config" doc:id="d54deb47-5647-44c4-b7c8-19b49b77a4a5" >
		<sdc:oauth-user-pass-connection audienceUrl="${server.audienceUrl}" username="${server.userName}" password="${server.password}" clientId="${server.consumerKey}" clientSecret="${server.consumerSecret}"/>
	</sdc:sdc-config>

	<flow name="query-objectsFlow" doc:id="973eb1df-5995-4d2f-a98e-ecb255bc36ac" >
		<http:listener doc:name="POST /query" doc:id="cc7e468d-ea29-4c81-b7d9-2d775a559413" config-ref="HTTP_Listener_config" path="/query" allowedMethods="POST"/>
		<logger level="INFO" doc:name="Request Logger" doc:id="ad692812-0267-4c5d-b1be-7ba121980ef8" message="#[payload]"/>
		<sdc:query doc:name="Query" doc:id="9248651a-fb67-40a4-a5f3-c4b2017c072b" config-ref="Salesforce_CDP_OAuth_JWT_config"/>
		<logger level="INFO" doc:name="Response Logger" doc:id="e7f675d9-113b-4ea8-929b-ed0b66fba977" message="#[payload]"/>
	</flow>
</mule>
----

=== Steps for running this example

// Add these steps to the end of the numbered list:
. Make sure your connector is already configured
. Save the project.
. Test the flow by sending a POST to localhost:8081/query with SOQL query in the request body, for example:
[source,json,linenums]
----
{
    "sql": "SELECT ID FROM ACCOUNT LIMIT 1"
}
----

== Delete Data - Streaming API

This Mule flow shows how to delete data via the streaming api using an object's endpoint.
Here is what each operation is doing:

* HTTP Listener: Accepts data from HTTP PUT requests with the connector and object name as uri parameters and record ids as query parameters.
* Logger: Shows the HTTP request received from the Listener, then later shows the result from the Delete Objects operation.
* Streaming Delete:
+
** Authenticates based on your choice between JWT or username password
** Receives the connector name, object name, and record ids from before
** Calls the Salesforce API to delete the records from the query params using that object's endpoint

image::delete-flow.png[]

=== XML for this example

Paste this code into the Studio XML editor to quickly load the flow for this example into your Mule app:

[source,xml,linenums]
----
<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:sdc="http://www.mulesoft.org/schema/mule/sdc" xmlns:http="http://www.mulesoft.org/schema/mule/http"
	  xmlns="http://www.mulesoft.org/schema/mule/core"
	  xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/sdc http://www.mulesoft.org/schema/mule/sdc/current/mule-sdc.xsd">
	<http:listener-config name="HTTP_Listener_config" doc:name="HTTP Listener config" doc:id="73958bf0-0d4b-41bb-9628-904ad234ab83" >
		<http:listener-connection host="0.0.0.0" port="8081" />
	</http:listener-config>
    <configuration-properties doc:name="Configuration properties" doc:id="5be8f024-2cd5-44ba-ab5d-83fb70236381" file="mule-app.properties" />
    <sdc:sdc-config name="Salesforce_CDP_OAuth_JWT_config" doc:name="Salesforce CDP config" doc:id="db8d8261-133b-44a3-908c-90d4b977687c" >
		<sdc:oauth-jwt-connection consumerKey="${server.consumerKey}" keyStorePath="${server.keyStorePath}" storePassword="${server.keyStorePassword}" subject="${server.userName}" keyAlias="${server.certificateAlias}" audienceUrl="${server.audienceUrl}"/>
	</sdc:sdc-config>
	<sdc:sdc-config name="Salesforce_Data_Cloud_OAuth_UsernamePassword_config" doc:name="Salesforce CDP config" doc:id="d54deb47-5647-44c4-b7c8-19b49b77a4a5" >
		<sdc:oauth-user-pass-connection audienceUrl="${server.audienceUrl}" username="${server.userName}" password="${server.password}" clientId="${server.consumerKey}" clientSecret="${server.consumerSecret}"/>
	</sdc:sdc-config>

	<flow name="delete-objectsFlow" doc:id="6610faf2-e073-4329-8683-44b1dfe4c417" >
		<http:listener doc:name="DELETE /delete/{connectorName}/{objectName}" doc:id="e4e9f2ee-b663-4346-9ad8-7a85b363a705" config-ref="HTTP_Listener_config" path="/delete/{connectorName}/{objectName}" allowedMethods="DELETE"/>
		<logger level="INFO" doc:name="Request Logger" doc:id="bfb377f8-bd95-4b97-a5e6-d6acc22a1cbc" />
		<sdc:delete-objects doc:name="Streaming Delete" doc:id="e3f83699-36d2-401d-bc8d-32df5b1b44ca" config-ref="Salesforce_CDP_OAuth_JWT_config" idsQueryParams="#[output application/java&#10;---&#10;[attributes.queryParams.ids]]" connectorNameUriParam="#[attributes.uriParams.connectorName]" objectNameUriParam="#[attributes.uriParams.objectName]"/>
		<logger level="INFO" doc:name="Response Logger" doc:id="148364d5-413c-4427-806f-5a1407ce4955" />
	</flow>
</mule>
----

=== Steps for running this example

. Make sure your connector is already configured
. Save the project.
. Test the flow by sending a DELETE to
localhost:8081/delete/{CONNECTOR_NAME}/{OBJECT_NAME}?ids={RECORD_NUMBER},{RECORD_NUMBER}. For example:
[source,json,linenums]
----
localhost:8081/delete/My_Connector/My_Object?ids=1,2,3
----

== See Also

* xref:connectors::introduction/introduction-to-anypoint-connectors.adoc[Introduction to Anypoint Connectors]
* https://help.mulesoft.com[MuleSoft Help Center]
